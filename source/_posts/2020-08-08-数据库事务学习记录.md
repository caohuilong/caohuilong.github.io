---
title: 数据库事务学习记录
date: 2020-08-08 16:10:05
categories:
  - "MySQL"
tags:
  - "MySQL"
---

本文记录在学习数据库事务中的一些关键概念，包括事务的ACID特性、多事务同时执行可能存在的问题、事务的隔离级别，最后对数据库的长连接与长事务做了一个对比。

<!--more-->

##### 事务的ACID特性：

- 原子性（Atomicity）：一个事务（transaction）中的所有操作，或者全部完成，或者全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。即，事务不可分割、不可约简。
- 一致性（Consistency）：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设约束、触发器、级联回滚等。
- 隔离性（Isolation）：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括未提交读、提交读、可重复读和串行化。
- 持久性（Durability）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

##### 多事务同时执行可能存在的问题：

- 脏读（dirty read）：读到其他事务未提交的数据。
- 不可重复读（non-repeatable read）：前后读取的记录内容不一致。
- 幻读（phantom read）：前后读取的记录数量不一致。

##### 隔离性与隔离级别

- 读未提交（read uncommitted）：一个事务还没提交时，它做的变更就能被别的事务看到。
- 读提交（read committed）：一个事务提交之后，它做的变更才会被其他事务看到。
- 可重复读（repeatable read）：一个事务执行过程中看到的数据，总是跟这个事务在启动时看到的数据是一致的。当然在可重复读隔离级别下，未提交变更对其他事务也是不可见的。
- 串行化（serializable）：顾名思义是对于同一行记录，“写”会加“写锁”，“读”会加“读锁”。当出现读写锁冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行。

##### 长连接与长事务

- 长连接：是指连接数据库成功后，如果客户端持续有请求，则一直使用同一个连接。对应的短连接则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。

  建立连接的过程通常是比较复杂的，所以我建议你在使用中要尽量减少建立连接的动作，**也就是尽量使用长连接**。但是全部使用长连接后，你可能会发现，有些时候 MySQL 占用内存涨得特别快，这是因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。

- 长事务：一直不提交的事务，就是长事务。**尽量不要使用长事务**，因为长事务意味着系统里面会存在很老的事务视图。由于这些事务随时可能访问数据库里面的任何数据，所以这个事务提交之前，数据库里面它可能用到的回滚记录都必须保留，这就会导致大量占用存储空间。除了对回滚段的影响，长事务还占用锁资源，也可能拖垮整个库。